<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½±åƒé­”æ–¹</title>
    <style>
        :root {
            --accent: #4f6df0;
            --accent-hover: #3d5fde;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --text-muted: #9ca3af;
            --background: #f7f9fc;
            --surface: #eef2f7;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(15, 23, 42, 0.08);
            --error: #ef4444;
            --success: #10b981;
            --info: #3b82f6;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.10);
            --shadow-lg: 0 16px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 0.375rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.25rem;
            --transition: all 0.22s ease;
            /* èƒŒæ™¯å…‰æ™•å˜é‡ */
            --bg-glow-1: rgba(79, 109, 240, 0.10);
            --bg-glow-2: rgba(79, 109, 240, 0.08);
            /* ç§‘æŠ€æ„Ÿæ¸å˜è‰² */
            --accent-cyan: #22d3ee;
            --accent-purple: #a855f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background:
                radial-gradient(900px circle at -12% -12%, var(--bg-glow-1), transparent 65%),
                radial-gradient(750px circle at 112% 122%, var(--bg-glow-2), transparent 60%),
                linear-gradient(180deg, var(--background) 0%, var(--surface) 100%);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .container {
            max-width: 1280px;
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg), 0 0 0 1px rgba(79, 109, 240, 0.25), 0 0 24px rgba(79, 109, 240, 0.12), 0 0 36px rgba(34, 211, 238, 0.10);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            z-index: 1;
        }

        #bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        #glass-overlay {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            /* ç§‘æŠ€æ„Ÿç½‘æ ¼å åŠ  */
            background-image:
                repeating-linear-gradient(0deg, rgba(31, 41, 55, 0.05) 0px, rgba(31, 41, 55, 0.05) 1px, transparent 1px, transparent 24px),
                repeating-linear-gradient(90deg, rgba(31, 41, 55, 0.04) 0px, rgba(31, 41, 55, 0.04) 1px, transparent 1px, transparent 24px);
        }

        #glass-overlay::before,
        #glass-overlay::after {
            content: '';
            position: absolute;
            width: 540px;
            height: 540px;
            border-radius: 50%;
            filter: blur(32px) saturate(120%);
            opacity: 0.35;
        }

        #glass-overlay::before {
            top: -80px;
            left: -90px;
            background: radial-gradient(60% 60% at 35% 35%, rgba(79, 109, 240, 0.22) 0%, rgba(79, 109, 240, 0.10) 40%, rgba(255, 255, 255, 0.06) 70%, transparent 100%);
        }

        #glass-overlay::after {
            bottom: -120px;
            right: -100px;
            background: radial-gradient(60% 60% at 65% 65%, rgba(16, 185, 129, 0.18) 0%, rgba(16, 185, 129, 0.08) 40%, rgba(255, 255, 255, 0.05) 70%, transparent 100%);
        }

        header {
            background: var(--glass-bg);
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 1.75rem 2rem 1.25rem;
            text-align: center;
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.375rem;
            letter-spacing: -0.02em;
        }

        header p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        main {
            padding: 2rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab {
            flex: none;
            padding: 0.65rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.98rem;
            color: var(--text-light);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 999px;
        }

        .tab:hover {
            color: var(--text-color);
        }

        .tab.active {
            color: var(--text-color);
            background: linear-gradient(90deg, rgba(79, 109, 240, 0.12), rgba(34, 211, 238, 0.10));
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(79, 109, 240, 0.35), 0 0 14px rgba(79, 109, 240, 0.18);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.2s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 1.1rem;
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.45rem;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            font-size: 1.05rem;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.85);
            color: var(--text-color);
            font-family: inherit;
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--text-light);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(79, 109, 240, 0.12);
            background: #ffffff;
        }

        textarea {
            resize: vertical;
            min-height: 110px;
            line-height: 1.6;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }

        button {
            background: linear-gradient(90deg, var(--accent), var(--accent-cyan));
            color: white;
            border: none;
            padding: 0.9rem 1.2rem;
            border-radius: var(--radius-md);
            font-size: 1.06rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 0 1px rgba(79, 109, 240, 0.35), 0 10px 20px rgba(79, 109, 240, 0.18);
        }

        button:hover {
            background: linear-gradient(90deg, var(--accent-hover), var(--accent-cyan));
            transform: translateY(-1px);
            box-shadow: 0 0 0 1px rgba(79, 109, 240, 0.45), 0 14px 26px rgba(79, 109, 240, 0.22);
        }

        /* é¼ æ ‡è·Ÿè¸ªé«˜å…‰ */
        button::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(180px circle at var(--mouse-x) var(--mouse-y), rgba(34, 211, 238, 0.28), rgba(168, 85, 247, 0.18) 30%, transparent 60%);
            opacity: var(--glow-alpha, 0);
            transition: opacity 0.18s ease;
            filter: blur(10px);
            mix-blend-mode: screen;
        }

        /* ç‚¹å‡»æ¶Ÿæ¼ª */
        .ripple {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            pointer-events: none;
            background: radial-gradient(closest-side, rgba(255, 255, 255, 0.8), rgba(79, 109, 240, 0.5) 60%, transparent 100%);
            transform: scale(0);
            opacity: 0.85;
            animation: ripple 650ms ease-out forwards;
        }

        @keyframes ripple {
            to {
                transform: scale(22);
                opacity: 0;
            }
        }

        /* èƒŒæ™¯æ¿æ¶Ÿæ¼ªï¼ˆæ›´å¤§ã€æ›´æŸ”ï¼‰ */
        .ripple-bg {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            pointer-events: none;
            background: radial-gradient(closest-side, rgba(255, 255, 255, 0.55), rgba(79, 109, 240, 0.35) 60%, transparent 100%);
            transform: scale(0);
            opacity: 0.40;
            animation: ripple-bg 900ms ease-out forwards;
        }

        @keyframes ripple-bg {
            to {
                transform: scale(60);
                opacity: 0;
            }
        }

        button:active {
            background: var(--accent);
        }

        .result {
            margin-top: 1.1rem;
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: var(--transition);
        }

        .message {
            padding: 0.85rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.85rem;
            font-size: 0.9rem;
            text-align: center;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
        }

        .message.info {
            color: var(--info);
        }

        .message.error {
            color: var(--error);
        }

        .message.success {
            color: var(--success);
        }

        .image-container {
            margin-top: 0.7rem;
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: var(--transition);
            background: #ffffff;
            padding: 0.7rem;
            border: 1px solid var(--glass-border);
        }

        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-sm);
            display: block;
            margin: 0 auto;
        }

        /* Upload area and thumbs */
        .upload-area {
            border: 2px dashed var(--glass-border);
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            padding: 1.2rem;
            text-align: center;
            color: var(--text-light);
        }

        .upload-icon {
            font-size: 1.5rem;
        }

        .upload-text {
            margin-top: 0.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .upload-hint {
            margin-top: 0.25rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .upload-area.dragover {
            border-color: var(--accent);
            background: rgba(79, 109, 240, 0.08);
        }

        .thumb-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 0.6rem;
        }

        .thumb-item {
            position: relative;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            color: #ef4444;
            font-size: 14px;
            z-index: 2;
        }

        .thumb-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }

        .thumb-item img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-sm);
        }

        .thumb-name {
            display: block;
            margin-top: 6px;
            font-size: 0.8rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* è§’è‰²èˆå°æ ·å¼ */
        .character-stage {
            position: relative;
            margin: 0.8rem 0 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            overflow: hidden;
            height: auto;
            min-height: 220px;
        }

        .character-stage canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 1.05rem;
            height: 1.05rem;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
                background:
                    radial-gradient(650px circle at -20% -20%, var(--bg-glow-1), transparent 68%),
                    radial-gradient(520px circle at 115% 120%, var(--bg-glow-2), transparent 62%),
                    linear-gradient(180deg, var(--background) 0%, var(--surface) 100%);
            }

            .container {
                border-radius: var(--radius-lg);
            }

            header {
                padding: 1.4rem;
            }

            h1 {
                font-size: 1.6rem;
            }

            main {
                padding: 1.1rem;
            }

            .thumb-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Hero & Features */
        header.hero {
            padding: 2rem 2rem 1.25rem;
            text-align: left;
            background: var(--glass-bg);
            border-bottom: 1px solid var(--glass-border);
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .brand-logo {
            font-weight: 700;
            letter-spacing: 0.02em;
            color: var(--text-color);
        }

        .login-link {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 600;
            border: 1px solid var(--glass-border);
            padding: 0.42rem 0.8rem;
            border-radius: 999px;
            transition: var(--transition);
        }

        .login-link:hover {
            color: var(--text-color);
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(79, 109, 240, 0.35);
        }

        .hero-inner {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            align-items: center;
            gap: 1.5rem;
        }

        .hero-title {
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .accent-gradient {
            background: linear-gradient(90deg, var(--accent), var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            color: transparent;
        }

        .hero-subtitle {
            color: var(--text-light);
            font-size: 1.05rem;
            margin-bottom: 1rem;
        }

        .hero-cta {
            width: auto;
            padding: 0.9rem 1.6rem;
            font-size: 1.05rem;
        }

        .hero-visual .character-stage {
            margin-top: 0;
        }

        .feature-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding: 1.25rem 0 0;
        }

        .feature-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .feature-icon {
            font-size: 1.6rem;
        }

        .feature-title {
            font-weight: 700;
            margin-top: 0.4rem;
        }

        .feature-desc {
            color: var(--text-muted);
            font-size: 0.92rem;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .hero-inner {
                grid-template-columns: 1fr;
            }

            .feature-cards {
                grid-template-columns: 1fr;
            }

            .hero-title {
                font-size: 2rem;
            }
        }
    </style>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <canvas id="bg-canvas" aria-hidden="true"></canvas>
    <div id="glass-overlay" aria-hidden="true"></div>
    <div class="container">
        <header class="hero">
            <div class="topbar">
                <div class="brand"><span class="brand-logo">Image Cube</span></div>
                <a class="login-link" href="#" onclick="scrollToGenerator()">å¼€å§‹ä½“éªŒ</a>
            </div>
            <div class="hero-inner">
                <div class="hero-copy">
                    <h1 class="hero-title">å½±åƒé­”æ–¹ Â· <span class="accent-gradient">AIä¿®å›¾</span></h1>
                    <p class="hero-subtitle">ä¸€é”®æ–‡ç”Ÿå›¾ã€AIä¿®å›¾ã€æ‰¹é‡ä¼˜é€‰ï¼Œè½»æ¾ç”Ÿæˆç´ æ</p>
                    <button class="hero-cta" id="hero-cta" onclick="scrollToGenerator()">å¼€å§‹ç”Ÿæˆ</button>
                </div>
                <div class="hero-visual">
                    <div class="character-stage">
                        <canvas id="character-canvas"></canvas>
                        <video id="character-video" muted playsinline preload="auto" style="display:none"></video>
                        <video id="warning-video" muted playsinline preload="auto" style="display:none"></video>
                        <!-- çµåŠ¨è§†é¢‘å…ƒç´  -->
                        <video id="action-video-1" muted playsinline preload="auto" style="display:none"></video>
                        <video id="action-video-2" muted playsinline preload="auto" style="display:none"></video>
                        <video id="action-video-3" muted playsinline preload="auto" style="display:none"></video>
                        <video id="action-video-4" muted playsinline preload="auto" style="display:none"></video>
                    </div>
                </div>
            </div>
            <div class="feature-cards">
                <div class="feature-card"
                    onclick="document.querySelector('.tab:nth-child(1)').click(); document.querySelector('main').scrollIntoView({behavior:'smooth'});">
                    <div class="feature-icon">ğŸ–¼ï¸</div>
                    <div class="feature-title">AI ä¿®å›¾</div>
                    <div class="feature-desc">å‚è€ƒå›¾ç‰‡+ä¿®å›¾è¯´æ˜ï¼Œä¸€é”®ä¼˜åŒ–</div>
                </div>
                <div class="feature-card"
                    onclick="document.querySelector('.tab:nth-child(2)').click(); document.querySelector('main').scrollIntoView({behavior:'smooth'});">
                    <div class="feature-icon">ğŸ“</div>
                    <div class="feature-title">æ–‡ç”Ÿå›¾</div>
                    <div class="feature-desc">è¾“å…¥æè¿°ï¼ŒAIç”Ÿæˆç²¾ç¾å›¾ç‰‡</div>
                </div>
                <div class="feature-card"
                    onclick="document.querySelector('.tab:nth-child(3)').click(); document.querySelector('main').scrollIntoView({behavior:'smooth'});">
                    <div class="feature-icon">âœ¨</div>
                    <div class="feature-title">æ‰¹é‡ä¼˜é€‰</div>
                    <div class="feature-desc">ä¸€æ¬¡ä¸Šä¼ ï¼Œå¤šç»´è¯„åˆ†é€‰æœ€ä¼˜</div>
                </div>
            </div>
        </header>

        <main>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('image-to-image')"><span class="accent-gradient">AI ä¿®å›¾</span>
                </div>
                <div class="tab" onclick="switchTab('text-to-image')">æ–‡ç”Ÿå›¾</div>
                <div class="tab" onclick="switchTab('bulk-select')">æ‰¹é‡ä¼˜é€‰</div>
                <div class="tab" onclick="switchTab('ai-evaluate')">AIè¯„ä»·</div>
                <div class="tab" onclick="switchTab('history')">å†å²è®°å½•</div>
            </div>

            <!-- æ–‡ç”Ÿå›¾è¡¨å• -->
            <div id="text-to-image" class="tab-content">
                <div class="form-group">
                    <label for="text-prompt">å›¾ç‰‡æè¿°</label>
                    <textarea id="text-prompt" placeholder="è¯·è¾“å…¥è¯¦ç»†çš„å›¾ç‰‡æè¿°..."></textarea>
                </div>
                <div class="form-group">
                    <label for="text-size">å›¾ç‰‡å°ºå¯¸</label>
                    <select id="text-size">
                        <option value="2K">2K (2560Ã—1440)</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="text-watermark" checked>
                        <label for="text-watermark">æ·»åŠ æ°´å°</label>
                    </div>
                </div>
                <button id="text-button" onclick="generateTextToImage()">
                    <span>ç”Ÿæˆå›¾ç‰‡</span>
                </button>

                <div id="text-result" class="result"></div>
            </div>

            <!-- AI ä¿®å›¾è¡¨å•ï¼ˆåŸå›¾æ–‡ç”Ÿå›¾ï¼‰ -->
            <div id="image-to-image" class="tab-content active">
                <div class="form-group">
                    <label for="image-prompt">ä¿®å›¾è¯´æ˜</label>
                    <textarea id="image-prompt" placeholder="è¯·è¾“å…¥è¯¦ç»†çš„ä¿®å›¾è¯´æ˜ï¼ˆå¯ä»AIè¯„ä»·ç¼ºç‚¹ä¸€é”®å¡«å……ï¼‰..."></textarea>
                </div>
                <div class="form-group">
                    <label>å‚è€ƒå›¾ç‰‡ï¼ˆæ‹–æ‹½ä¸Šä¼ æˆ–ç‚¹å‡»é€‰æ‹©ï¼‰</label>
                    <div id="ref-upload-area" class="upload-area" onclick="document.getElementById('ref-file').click()">
                        <div class="upload-icon">ğŸ–¼ï¸</div>
                        <div class="upload-text">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                        <div class="upload-hint">æ”¯æŒ JPG/PNG/WebPï¼Œä¸Šä¼ åè‡ªåŠ¨ç”ŸæˆURL</div>
                    </div>
                    <input type="file" id="ref-file" accept="image/*" style="display:none"
                        onchange="handleRefFileSelect(event)">
                    <div id="ref-preview" class="thumb-grid" style="grid-template-columns: repeat(1, 1fr);"></div>
                    <div id="ref-upload-result" class="result"></div>
                </div>
                <div class="form-group">
                    <label for="reference-image">å‚è€ƒå›¾ç‰‡URLï¼ˆå¯é€‰ï¼Œä¸Šä¼ åè‡ªåŠ¨å¡«å……ï¼‰</label>
                    <input type="text" id="reference-image" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label for="image-size">å›¾ç‰‡å°ºå¯¸</label>
                    <select id="image-size">
                        <option value="2K">2K (2560Ã—1440)</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="image-watermark" checked>
                        <label for="image-watermark">æ·»åŠ æ°´å°</label>
                    </div>
                </div>
                <button id="image-button" onclick="generateImageToImage()">
                    <span>å¼€å§‹ä¿®å›¾</span>
                </button>

                <div id="image-result" class="result"></div>
            </div>

            <!-- æ‰¹é‡ä¼˜é€‰ -->
            <div id="bulk-select" class="tab-content">
                <div class="form-group">
                    <label for="bulk-images">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="upload-area" onclick="document.getElementById('bulk-images').click()">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                        <div class="upload-hint">æœ€å¤šé€‰æ‹© 20 å¼ ï¼Œæ”¯æŒ JPG/PNG/WebP</div>
                    </div>
                    <input type="file" id="bulk-images" accept="image/*" multiple style="display:none"
                        onchange="updateBulkPreview()">
                </div>
                <div id="bulk-preview" class="thumb-grid"></div>
                <button id="bulk-button" onclick="generateBestImageSelection()">
                    <span>å¼€å§‹ä¼˜é€‰</span>
                </button>
                <div id="bulk-result" class="result"></div>
            </div>

            <!-- AIè¯„ä»· -->
            <div id="ai-evaluate" class="tab-content">
                <div class="form-group">
                    <label>ä¸Šä¼ ç…§ç‰‡è¿›è¡ŒAIè¯„ä»·</label>
                    <div class="upload-area" id="eval-upload-area"
                        onclick="document.getElementById('eval-file').click()">
                        <div class="upload-icon">ğŸ“·</div>
                        <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ç…§ç‰‡åˆ°æ­¤å¤„</div>
                        <div class="upload-hint">æ”¯æŒ JPG/PNG/WebP</div>
                    </div>
                    <input type="file" id="eval-file" accept="image/*" style="display:none"
                        onchange="handleEvalFileSelect(event)">
                    <div id="eval-preview" class="thumb-grid" style="grid-template-columns: repeat(1, 1fr);"></div>
                </div>
                <button id="eval-button" onclick="startAiEvaluate()"><span>å¼€å§‹è¯„ä»·</span></button>
                <div id="eval-result" class="result"></div>
            </div>

            <!-- å†å²è®°å½• -->
            <div id="history" class="tab-content">
                <div class="form-group" style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
                    <button onclick="loadHistory()" style="min-width:110px"><span>åˆ·æ–°å†å²</span></button>
                </div>
                <div id="history-grid" class="thumb-grid"></div>
                <div id="history-result" class="result"></div>
            </div>

        </main>
    </div>

    <script>
        // åŠ¨æ€åƒç´ èƒŒæ™¯ï¼ˆCanvasï¼‰
        (function () {
            const canvas = document.getElementById('bg-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let dpi = window.devicePixelRatio || 1;

            let mouse = { x: -9999, y: -9999 };
            let width = 0, height = 0, cols = 0, rows = 0;
            const cell = 30; // åƒç´ æ–¹æ ¼å¤§å°
            const radius = 50; // å½±å“åŠå¾„ï¼ˆæ›´å°èŒƒå›´ï¼‰
            const baseAlpha = 0.04; // åŸºç¡€é€æ˜åº¦
            const maxAlpha = 0.5; // é¼ æ ‡é™„è¿‘å¢å¼ºé€æ˜åº¦ï¼ˆæ›´äº®ï¼‰
            const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4f6df0';
            const neutralPrefix = 'rgba(31,41,55,'; // æ·±ç°è½»ç‚¹
            let field = [];
            let ripples = [];

            function resize() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                canvas.width = Math.floor(width * dpi);
                canvas.height = Math.floor(height * dpi);
                cols = Math.ceil(width / cell);
                rows = Math.ceil(height / cell);
                field = new Array(cols * rows).fill(baseAlpha);
                draw(true);
            }

            function lerp(a, b, t) { return a + (b - a) * t; }

            function toRGBA(hex, alpha) {
                // ç®€å•hexè½¬rgbaï¼Œä»…æ”¯æŒ #rrggbb
                const m = hex.match(/^#([0-9a-fA-F]{6})$/);
                if (!m) return `rgba(79,109,240,${alpha})`;
                const int = parseInt(m[1], 16);
                const r = (int >> 16) & 255;
                const g = (int >> 8) & 255;
                const b = int & 255;
                return `rgba(${r},${g},${b},${alpha})`;
            }

            function draw(initial) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.scale(dpi, dpi);

                const now = performance.now();
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const x = c * cell;
                        const y = r * cell;
                        const cx = x + cell / 2;
                        const cy = y + cell / 2;
                        const dx = cx - mouse.x;
                        const dy = cy - mouse.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        const t = Math.max(0, 1 - dist / radius);

                        // è”åŠ¨æ¶Ÿæ¼ªï¼šè®¡ç®—å½“å‰åƒç´ æ ¼å—åˆ°çš„ç¯å½¢å½±å“
                        let rippleInfluence = 0;
                        for (let i = 0; i < ripples.length; i++) {
                            const rp = ripples[i];
                            const tr = Math.min((now - rp.start) / rp.duration, 1);
                            if (tr <= 0 || tr >= 1) continue;
                            const rr = rp.maxRadius * tr;
                            const drx = cx - rp.x;
                            const dry = cy - rp.y;
                            const dr = Math.sqrt(drx * drx + dry * dry);
                            const ringWidth = 80; // æ³¢çº¹åšåº¦
                            const delta = Math.abs(dr - rr);
                            const ringFactor = Math.max(0, 1 - delta / ringWidth);
                            rippleInfluence = Math.max(rippleInfluence, ringFactor * rp.alpha);
                        }

                        const mouseTerm = t * (maxAlpha - baseAlpha);
                        const rippleTerm = rippleInfluence * (maxAlpha - baseAlpha) * 0.8;
                        const target = Math.min(maxAlpha, baseAlpha + mouseTerm + rippleTerm);
                        const idx = r * cols + c;
                        const prev = field[idx];
                        const next = initial ? target : lerp(prev, target, 0.18);
                        field[idx] = next;

                        const accentTrigger = Math.max(t, rippleInfluence * 0.9);
                        const fill = accentTrigger > 0.15 ? toRGBA(accent, next) : (neutralPrefix + next + ')');
                        ctx.fillStyle = fill;
                        ctx.fillRect(x, y, cell - 1, cell - 1);
                    }
                }
                // æ¶Ÿæ¼ªä¸åƒç´ æ ¼å·²è”åŠ¨ï¼Œå–æ¶ˆå åŠ ç»˜åˆ¶
                ctx.restore();
                requestAnimationFrame(step);
            }

            function step() { draw(false); }

            window.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; }, { passive: true });
            window.addEventListener('mouseleave', () => { mouse.x = -9999; mouse.y = -9999; });

            const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            if (prefersReduced || isMobile) {
                const el = document.getElementById('bg-canvas');
                if (el) el.style.display = 'none';
            } else {
                window.addEventListener('resize', resize);
                resize();
                // èƒŒæ™¯åƒç´ æ¿ç‚¹å‡»æ¶Ÿæ¼ªï¼Œä»…åœ¨éæ§ä»¶åŒºåŸŸè§¦å‘
                window.addEventListener('mousedown', (e) => {
                    if (prefersReduced || isMobile) return;
                    if (e.target && e.target.closest('.container, button, a, input, textarea, select, label, .tab')) return;
                    ripples.push({
                        x: e.clientX,
                        y: e.clientY,
                        start: performance.now(),
                        duration: 900,
                        maxRadius: Math.max(width, height) * 0.45,
                        alpha: 0.35
                    });
                }, { passive: true });
            }
        })();
    </script>

    <script>
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');

            // è®¾ç½®é€‰ä¸­æ ‡ç­¾ä¸ºæ´»åŠ¨çŠ¶æ€
            event.currentTarget.classList.add('active');

            // å¦‚æœæ˜¯å†å²è®°å½•æ ‡ç­¾ï¼ŒåŠ è½½æ•°æ®
            if (tabName === 'history') {
                loadHistory(true);
            }
        }

        // Hero åŒºåŸŸ CTA å¿«é€Ÿè·³è½¬åˆ°ç”Ÿæˆæ¨¡å—
        function scrollToGenerator() {
            const firstTab = document.querySelector('.tab:nth-child(1)');
            if (firstTab) firstTab.click();
            const main = document.querySelector('main');
            if (main) main.scrollIntoView({ behavior: 'smooth' });
            const prompt = document.getElementById('image-prompt');
            if (prompt) prompt.focus();
        }

        function generateTextToImage() {
            const prompt = document.getElementById('text-prompt').value;
            const size = document.getElementById('text-size').value;
            const watermark = document.getElementById('text-watermark').checked;
            const button = document.getElementById('text-button');
            const originalButtonText = button.innerHTML;

            if (!prompt) {
                console.log('ç”¨æˆ·æœªè¾“å…¥æè¿°ï¼Œå‡†å¤‡æ’­æ”¾è­¦å‘ŠåŠ¨ç”»');
                // æ’­æ”¾è­¦å‘ŠåŠ¨ç”»
                if (typeof playWarningAnimation === 'function') {
                    console.log('è°ƒç”¨playWarningAnimationå‡½æ•°');
                    playWarningAnimation();
                } else {
                    console.error('playWarningAnimationå‡½æ•°ä¸å­˜åœ¨');
                }
                showResult('text-result', 'è¯·è¾“å…¥å›¾ç‰‡æè¿°', 'error');
                return;
            }

            // åœæ­¢è­¦å‘ŠåŠ¨ç”»ï¼Œå¼€å§‹æ­£å¸¸çš„è§’è‰²åŠ¨ç”»
            if (typeof stopCharacterAnimation === 'function') {
                stopCharacterAnimation();
            }
            if (typeof playCharacterAnimation === 'function') {
                playCharacterAnimation();
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> <span>ç”Ÿæˆä¸­...</span>';

            // å¼€å§‹å¾ªç¯æ’­æ”¾è§’è‰²åŠ¨ç”»
            console.log('å¼€å§‹å›¾ç‰‡ç”Ÿæˆï¼Œå¯åŠ¨è§’è‰²åŠ¨ç”»å¾ªç¯æ’­æ”¾');
            if (typeof playCharacterAnimation === 'function') {
                try {
                    playCharacterAnimation(true); // ä¼ å…¥trueå¯ç”¨å¾ªç¯æ’­æ”¾
                    console.log('è§’è‰²åŠ¨ç”»å·²å¯åŠ¨');
                } catch (e) {
                    console.error('å¯åŠ¨è§’è‰²åŠ¨ç”»å¤±è´¥:', e);
                }
            } else {
                console.warn('playCharacterAnimationå‡½æ•°æœªæ‰¾åˆ°');
            }

            showResult('text-result', 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...', 'info');

            fetch('/api/generate/text-to-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,
                    size: size,
                    watermark: watermark
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showImageResult('text-result', data.image_url);
                    } else {
                        showResult('text-result', data.error || 'ç”Ÿæˆå¤±è´¥', 'error');
                    }
                })
                .catch(error => {
                    showResult('text-result', 'è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                })
                .finally(() => {
                    // åœæ­¢è§’è‰²åŠ¨ç”»æ’­æ”¾
                    console.log('å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œåœæ­¢è§’è‰²åŠ¨ç”»');
                    if (typeof stopCharacterAnimation === 'function') {
                        try {
                            stopCharacterAnimation();
                            console.log('è§’è‰²åŠ¨ç”»å·²åœæ­¢');
                        } catch (e) {
                            console.error('åœæ­¢è§’è‰²åŠ¨ç”»å¤±è´¥:', e);
                        }
                    } else {
                        console.warn('stopCharacterAnimationå‡½æ•°æœªæ‰¾åˆ°');
                    }

                    // å¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾
                    console.log('å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾');
                    if (typeof resetIdleTimer === 'function') {
                        try {
                            resetIdleTimer();
                            console.log('çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾å·²å¯åŠ¨');
                        } catch (e) {
                            console.error('å¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾å¤±è´¥:', e);
                        }
                    } else {
                        console.warn('resetIdleTimerå‡½æ•°æœªæ‰¾åˆ°');
                    }

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = originalButtonText;
                });
        }

        function generateImageToImage() {
            const prompt = document.getElementById('image-prompt').value;
            const imageUrlInput = document.getElementById('reference-image');
            const imageUrl = (window.refState && window.refState.url) || (imageUrlInput ? imageUrlInput.value : '');
            const size = document.getElementById('image-size').value;
            const watermark = document.getElementById('image-watermark').checked;
            const button = document.getElementById('image-button');
            const originalButtonText = button.innerHTML;

            if (!prompt) {
                // æ’­æ”¾è­¦å‘ŠåŠ¨ç”»
                if (typeof playWarningAnimation === 'function') {
                    playWarningAnimation();
                }
                showResult('image-result', 'è¯·è¾“å…¥å›¾ç‰‡æè¿°', 'error');
                return;
            }

            if (!imageUrl) {
                // æ’­æ”¾è­¦å‘ŠåŠ¨ç”»
                if (typeof playWarningAnimation === 'function') {
                    playWarningAnimation();
                }
                showResult('image-result', 'è¯·ä¸Šä¼ å‚è€ƒå›¾ç‰‡æˆ–å¡«å†™URL', 'error');
                return;
            }

            // åœæ­¢è­¦å‘ŠåŠ¨ç”»ï¼Œå¼€å§‹æ­£å¸¸çš„è§’è‰²åŠ¨ç”»
            if (typeof stopCharacterAnimation === 'function') {
                stopCharacterAnimation();
            }
            if (typeof playCharacterAnimation === 'function') {
                playCharacterAnimation();
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> <span>ç”Ÿæˆä¸­...</span>';

            // å¼€å§‹å¾ªç¯æ’­æ”¾è§’è‰²åŠ¨ç”»
            console.log('å¼€å§‹å›¾ç”Ÿå›¾ï¼Œå¯åŠ¨è§’è‰²åŠ¨ç”»å¾ªç¯æ’­æ”¾');
            if (typeof playCharacterAnimation === 'function') {
                try {
                    playCharacterAnimation(true); // ä¼ å…¥trueå¯ç”¨å¾ªç¯æ’­æ”¾
                    console.log('è§’è‰²åŠ¨ç”»å·²å¯åŠ¨');
                } catch (e) {
                    console.error('å¯åŠ¨è§’è‰²åŠ¨ç”»å¤±è´¥:', e);
                }
            } else {
                console.warn('playCharacterAnimationå‡½æ•°æœªæ‰¾åˆ°');
            }

            showResult('image-result', 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...', 'info');

            fetch('/api/generate/image-to-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,
                    image_url: imageUrl,
                    size: size,
                    watermark: watermark
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showImageResult('image-result', data.image_url);
                    } else {
                        showResult('image-result', data.error || 'ç”Ÿæˆå¤±è´¥', 'error');
                    }
                })
                .catch(error => {
                    showResult('image-result', 'è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                })
                .finally(() => {
                    // åœæ­¢è§’è‰²åŠ¨ç”»æ’­æ”¾
                    console.log('å›¾ç”Ÿå›¾å®Œæˆï¼Œåœæ­¢è§’è‰²åŠ¨ç”»');
                    if (typeof stopCharacterAnimation === 'function') {
                        try {
                            stopCharacterAnimation();
                            console.log('è§’è‰²åŠ¨ç”»å·²åœæ­¢');
                        } catch (e) {
                            console.error('åœæ­¢è§’è‰²åŠ¨ç”»å¤±è´¥:', e);
                        }
                    } else {
                        console.warn('stopCharacterAnimationå‡½æ•°æœªæ‰¾åˆ°');
                    }

                    // å¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾
                    console.log('å›¾ç”Ÿå›¾å®Œæˆï¼Œå¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾');
                    if (typeof resetIdleTimer === 'function') {
                        try {
                            resetIdleTimer();
                            console.log('çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾å·²å¯åŠ¨');
                        } catch (e) {
                            console.error('å¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾å¤±è´¥:', e);
                        }
                    } else {
                        console.warn('resetIdleTimerå‡½æ•°æœªæ‰¾åˆ°');
                    }

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = originalButtonText;
                });
        }

        function showResult(elementId, message, type) {
            const resultElement = document.getElementById(elementId);
            resultElement.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        function showImageResult(elementId, imageUrl) {
            const resultElement = document.getElementById(elementId);
            resultElement.innerHTML = `
                <div class="message success">å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼</div>
                <div class="image-container">
                    <img src="${imageUrl}" alt="ç”Ÿæˆçš„å›¾ç‰‡">
                </div>
            `;
        }

        // å†å²è®°å½•åŠ è½½ä¸æ¸²æŸ“ï¼ˆæ”¯æŒæ»šåŠ¨åŠ è½½ï¼‰
        const historyState = { loaded: 0, pageSize: 40, loading: false, allLoaded: false };

        function loadHistory(reset = true) {
            const grid = document.getElementById('history-grid');
            const resultEl = document.getElementById('history-result');

            if (reset) {
                historyState.loaded = 0;
                historyState.allLoaded = false;
                if (grid) grid.innerHTML = '';
            }
            if (resultEl) resultEl.innerHTML = '<div class="message info">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>';

            const limit = historyState.loaded + historyState.pageSize;
            historyState.loading = true;
            fetch('/api/history?limit=' + limit)
                .then(res => res.json())
                .then(data => {
                    if (!data.success) throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                    const items = data.items || [];
                    const append = items.slice(historyState.loaded);
                    renderHistory(append, /*append*/ true);
                    historyState.loaded = items.length;
                    historyState.allLoaded = items.length < limit;
                    if (resultEl) resultEl.innerHTML = historyState.allLoaded ? '<div class="message info">å·²å…¨éƒ¨åŠ è½½</div>' : '';
                })
                .catch(err => {
                    if (resultEl) resultEl.innerHTML = '<div class="message error">' + (err.message || 'åŠ è½½å¤±è´¥') + '</div>';
                })
                .finally(() => {
                    historyState.loading = false;
                });
        }
        function renderHistory(items, append = false) {
            const grid = document.getElementById('history-grid');
            if (!grid) return;
            if (!items.length && !append) {
                grid.innerHTML = '<div class="message info" style="grid-column:1/-1;">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            const html = items.map(it => {
                const title = (it.prompt || '').slice(0, 36);
                const url = it.image_url || '';
                const mode = it.mode === 'image_to_image' ? 'AI ä¿®å›¾' : 'æ–‡ç”Ÿå›¾';
                const time = (it.created_at || '').replace('T', ' ').slice(0, 19);
                return `
                    <div class="thumb-item" title="${mode} Â· ${time}" id="history-item-${it.id}">
                        <div class="delete-btn" onclick="deleteHistoryItem('${it.id}', event)" title="åˆ é™¤è®°å½•">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                        <a href="${url}" target="_blank" rel="noopener noreferrer">
                            <img src="${url}" alt="å†å²ç”Ÿæˆå›¾"/>
                        </a>
                        <span class="thumb-name">${mode} Â· ${title}</span>
                    </div>
                `;
            }).join('');
            if (append) {
                grid.insertAdjacentHTML('beforeend', html);
            } else {
                grid.innerHTML = html;
            }
        }

        function deleteHistoryItem(id, event) {
            if (event) event.stopPropagation();
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;

            fetch('/api/history/' + id, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const item = document.getElementById('history-item-' + id);
                        if (item) {
                            item.style.transition = 'all 0.2s ease';
                            item.style.opacity = '0';
                            item.style.transform = 'scale(0.9)';
                            setTimeout(() => item.remove(), 200);
                        }
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(err => {
                    console.error('åˆ é™¤è¯·æ±‚å¤±è´¥:', err);
                    alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
        }

        // ç›‘å¬çª—å£æ»šåŠ¨ï¼Œé è¿‘åº•éƒ¨è‡ªåŠ¨åŠ è½½æ›´å¤š
        window.addEventListener('scroll', () => {
            const historyTab = document.getElementById('history');
            const isActive = historyTab && historyTab.classList.contains('active');
            if (!isActive || historyState.loading || historyState.allLoaded) return;
            const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 240);
            if (nearBottom) {
                loadHistory(false);
            }
        });

        function generateBestImageSelection() {
            const input = document.getElementById('bulk-images');
            const files = Array.from(input.files);
            const button = document.getElementById('bulk-button');
            const originalButtonText = button.innerHTML;

            if (!files.length) {
                // æ’­æ”¾è­¦å‘ŠåŠ¨ç”»
                if (typeof playWarningAnimation === 'function') {
                    playWarningAnimation();
                }
                showResult('bulk-result', 'è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡', 'error');
                return;
            }

            // åœæ­¢è­¦å‘ŠåŠ¨ç”»ï¼Œå¼€å§‹æ­£å¸¸çš„è§’è‰²åŠ¨ç”»
            if (typeof stopCharacterAnimation === 'function') {
                stopCharacterAnimation();
            }
            if (typeof playCharacterAnimation === 'function') {
                playCharacterAnimation();
            }

            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> <span>ä¼˜é€‰ä¸­...</span>';
            showResult('bulk-result', 'æ­£åœ¨è¯„ä¼°å›¾ç‰‡è´¨é‡ï¼Œè¯·ç¨å€™...', 'info');

            const formData = new FormData();
            files.forEach(file => formData.append('images', file));

            fetch('/api/select/best-image', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const imgSrc = `data:image/${data.format || 'jpeg'};base64,${data.best_image_b64}`;
                        const resultElement = document.getElementById('bulk-result');
                        const scoreList = (data.scores || []).map((s, i) => `<li>å›¾ç‰‡ ${i + 1}: ${Number(s).toFixed(3)}</li>`).join('');
                        resultElement.innerHTML = `
                            <div class="message success">ä¼˜é€‰å®Œæˆï¼Œæœ€ä½³å›¾ç‰‡ä¸ºç¬¬ ${data.best_index + 1} å¼ </div>
                            <div class="image-container">
                                <img src="${imgSrc}" alt="æœ€ä½³å›¾ç‰‡">
                            </div>
                            <div class="message info" style="margin-top:0.75rem;">
                                è¯„åˆ†åˆ—è¡¨ï¼š
                                <ul style="margin-top:0.5rem; text-align:left; padding-left:1.25rem;">
                                    ${scoreList}
                                </ul>
                            </div>
                        `;
                    } else {
                        showResult('bulk-result', data.error || 'ä¼˜é€‰å¤±è´¥', 'error');
                    }
                })
                .catch(err => {
                    showResult('bulk-result', 'è¯·æ±‚å¤±è´¥: ' + err.message, 'error');
                })
                .finally(() => {
                    // å¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾
                    console.log('æ‰¹é‡å›¾ç‰‡ä¼˜é€‰å®Œæˆï¼Œå¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾');
                    if (typeof resetIdleTimer === 'function') {
                        try {
                            resetIdleTimer();
                            console.log('çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾å·²å¯åŠ¨');
                        } catch (e) {
                            console.error('å¯åŠ¨çµåŠ¨è§†é¢‘å¾ªç¯æ’­æ”¾å¤±è´¥:', e);
                        }
                    } else {
                        console.warn('resetIdleTimerå‡½æ•°æœªæ‰¾åˆ°');
                    }

                    button.disabled = false;
                    button.innerHTML = originalButtonText;
                });
        }

        function updateBulkPreview() {
            const input = document.getElementById('bulk-images');
            const files = Array.from(input.files);
            const preview = document.getElementById('bulk-preview');
            if (!files.length) { preview.innerHTML = ''; return; }
            const max = Math.min(files.length, 12);
            preview.innerHTML = '';
            for (let i = 0; i < max; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'thumb-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <span class="thumb-name">${file.name}</span>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            }
        }

        // å‚è€ƒå›¾ä¸Šä¼ æ‹–æ‹½ä¸é¢„è§ˆ
        const refState = { url: '', uploading: false };

        function handleRefFileSelect(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            uploadRefFile(file);
        }

        function initRefUploadDnD() {
            const area = document.getElementById('ref-upload-area');
            if (!area) return;
            area.addEventListener('dragover', (ev) => {
                ev.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (ev) => {
                ev.preventDefault();
                area.classList.remove('dragover');
                const files = ev.dataTransfer && ev.dataTransfer.files;
                if (files && files.length) {
                    uploadRefFile(files[0]);
                }
            });
        }

        function uploadRefFile(file) {
            if (!file) return;
            const resultEl = document.getElementById('ref-upload-result');
            const urlInput = document.getElementById('reference-image');
            const preview = document.getElementById('ref-preview');
            const formData = new FormData();
            formData.append('file', file);
            refState.uploading = true;
            if (resultEl) resultEl.innerHTML = '<div class="message info">æ­£åœ¨ä¸Šä¼ å‚è€ƒå›¾ç‰‡...</div>';
            fetch('/api/upload', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data && data.success && data.url) {
                        refState.url = data.url;
                        if (urlInput) urlInput.value = data.url;
                        if (preview) {
                            preview.innerHTML = `
                                <div class="thumb-item">
                                    <img src="${data.url}" alt="${file.name}">
                                    <span class="thumb-name">${file.name}</span>
                                </div>
                            `;
                        }
                        if (resultEl) resultEl.innerHTML = '<div class="message success">ä¸Šä¼ æˆåŠŸï¼Œå·²å¡«å……å‚è€ƒå›¾ç‰‡URL</div>';
                    } else {
                        throw new Error((data && data.error) || 'ä¸Šä¼ å¤±è´¥');
                    }
                })
                .catch(err => {
                    console.error('ä¸Šä¼ å¤±è´¥:', err);
                    if (resultEl) resultEl.innerHTML = '<div class="message error">ä¸Šä¼ å¤±è´¥ï¼š' + (err.message || err) + '</div>';
                })
                .finally(() => {
                    refState.uploading = false;
                });
        }

        // åˆå§‹åŒ–æ‹–æ‹½åŒºåŸŸ
        initRefUploadDnD();

        // AIè¯„ä»·æ‹–æ‹½ä¸ä¸Šä¼ 
        const evalState = { file: null };
        function handleEvalFileSelect(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            evalState.file = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const preview = document.getElementById('eval-preview');
                if (preview) {
                    preview.innerHTML = `
                        <div class="thumb-item">
                            <img src="${ev.target.result}" alt="é¢„è§ˆ">
                            <span class="thumb-name">${file.name}</span>
                        </div>
                    `;
                }
            };
            reader.readAsDataURL(file);
        }
        function initEvalUploadDnD() {
            const area = document.getElementById('eval-upload-area');
            if (!area) return;
            area.addEventListener('dragover', (ev) => { ev.preventDefault(); area.classList.add('dragover'); });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (ev) => {
                ev.preventDefault();
                area.classList.remove('dragover');
                const files = ev.dataTransfer && ev.dataTransfer.files;
                if (files && files.length) {
                    const dtf = new DataTransfer();
                    dtf.items.add(files[0]);
                    const input = document.getElementById('eval-file');
                    if (input) input.files = dtf.files;
                    handleEvalFileSelect({ target: { files } });
                }
            });
        }
        function startAiEvaluate() {
            const button = document.getElementById('eval-button');
            const original = button.innerHTML;
            const resultEl = document.getElementById('eval-result');
            if (!evalState.file) { showResult('eval-result', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ ç…§ç‰‡', 'error'); if (typeof playWarningAnimation === 'function') playWarningAnimation(); return; }
            if (typeof stopCharacterAnimation === 'function') stopCharacterAnimation();
            if (typeof playCharacterAnimation === 'function') playCharacterAnimation();
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> <span>è¯„ä»·ä¸­...</span>';
            showResult('eval-result', 'æ­£åœ¨è¿›è¡ŒAIè¯„ä»·ï¼Œè¯·ç¨å€™...', 'info');
            const formData = new FormData();
            formData.append('file', evalState.file);
            fetch('/api/evaluate/photo', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const raw = (data.evaluation || '');
                        const defects = parseDefectsFromEvaluation(raw);
                        const text = raw.replace(/\n/g, '<br>');
                        window.__aiEval__ = { defects, raw, file: evalState.file };
                        const editBtn = `<button style="margin-top:0.6rem" onclick="applyDefectsToEditor()"><span>æ ¹æ®ç¼ºç‚¹ä¸€é”®è·³è½¬åˆ° AI ä¿®å›¾</span></button>`;
                        resultEl.innerHTML = `<div class="message success">è¯„ä»·å®Œæˆ</div><div class="message" style="text-align:left">${text}</div>${editBtn}`;
                    } else {
                        showResult('eval-result', data.error || 'è¯„ä»·å¤±è´¥', 'error');
                    }
                })
                .catch(err => { showResult('eval-result', 'è¯·æ±‚å¤±è´¥: ' + err.message, 'error'); })
                .finally(() => {
                    if (typeof stopCharacterAnimation === 'function') { try { stopCharacterAnimation(); } catch (_) { } }
                    if (typeof resetIdleTimer === 'function') { try { resetIdleTimer(); } catch (_) { } }
                    button.disabled = false;
                    button.innerHTML = original;
                });
        }
        initEvalUploadDnD();

        // æ›´ç¨³å¥åœ°ä»AIè¯„ä»·å†…å®¹ä¸­æå–â€œç¼ºç‚¹â€æ®µè½
        function parseDefectsFromEvaluation(text) {
            if (!text) return '';
            let t = String(text).replace(/\r\n?|\u2028|\u2029/g, '\n');
            // å…è®¸å‰ç¼€ç¬¦å·ï¼Œå¦‚âŒâœ˜ç­‰
            const startIdx = t.search(/[âŒâœ˜\-\*\s]*ç¼ºç‚¹\s*[ï¼š:]/);
            let seg = '';
            if (startIdx >= 0) {
                let right = t.slice(startIdx);
                right = right.replace(/^[^\n]*\n?/, '');
                const endIdx = right.search(/(å¯æ“ä½œçš„)?(æ”¹è¿›)?å»ºè®®\s*[ï¼š:]/);
                seg = endIdx >= 0 ? right.slice(0, endIdx) : right;
            }
            // å›é€€ï¼šæŠ“å–ä»¥ -/â€¢/ç¼–å· å¼€å¤´çš„è‹¥å¹²è¡Œ
            if (!seg.trim()) {
                const lines = t.split('\n').filter(l => /^\s*([-â€¢]|\d+\.)/.test(l));
                seg = lines.join('\n');
            }
            if (!seg.trim()) seg = t;
            // æ¸…ç†markdownç²—ä½“æ˜Ÿå·
            seg = seg.replace(/\*{1,3}/g, '').replace(/^[\s\u200b]+|[\s\u200b]+$/g, '');
            return seg.trim();
        }

        // å°†ç¼ºç‚¹å¡«å……åˆ° AI ä¿®å›¾æ¨¡å—ï¼Œå¹¶æŠŠè¯„ä»·å›¾ç‰‡ä½œä¸ºå‚è€ƒå›¾
        function applyDefectsToEditor() {
            const defects = (window.__aiEval__ && window.__aiEval__.defects) || '';
            const promptInput = document.getElementById('image-prompt');
            const sizeInput = document.getElementById('image-size');
            // æ„é€ ä¿®å›¾è¯´æ˜
            const editPrompt = buildEditPrompt(defects);
            if (promptInput) promptInput.value = editPrompt;
            // ä¸Šä¼ è¯„ä»·å›¾ç‰‡ä½œä¸ºå‚è€ƒå›¾ï¼Œå¹¶è‡ªåŠ¨å¡«å……URLå’Œé¢„è§ˆ
            const file = (window.__aiEval__ && window.__aiEval__.file) || (evalState && evalState.file);
            if (file) {
                uploadRefFile(file); // å¤ç”¨å·²æœ‰å‡½æ•°
            }
            // è·³è½¬åˆ° AI ä¿®å›¾æ ‡ç­¾
            const tab = Array.from(document.querySelectorAll('.tab')).find(el => el.textContent.includes('AI ä¿®å›¾'));
            if (tab) tab.click();
            const main = document.querySelector('main');
            if (main) main.scrollIntoView({ behavior: 'smooth' });
            if (promptInput) promptInput.focus();
        }

        function buildEditPrompt(defects) {
            const base = 'è¯·æ ¹æ®ä»¥ä¸‹å›¾åƒç¼ºç‚¹è¿›è¡Œæœ‰é’ˆå¯¹æ€§çš„ä¿®å›¾ï¼š';
            const tips = 'å°½é‡ä¿æŒçœŸå®è´¨æ„Ÿï¼Œé¿å…è¿‡åº¦ç£¨çš®æˆ–å¤±çœŸï¼›ä¼˜å…ˆè¿›è¡Œå…‰å½±ã€æè´¨ã€ç»†èŠ‚ä¸æ„å›¾å¾®è°ƒã€‚';
            const cleaned = (defects || '').replace(/\*{1,3}/g, '').replace(/\n{3,}/g, '\n\n').trim();
            const content = cleaned || '';
            return `${base}\n${content}\n${tips}`.trim();
        }
    </script>

    <script>
        // è§’è‰²è§†é¢‘å»é»‘èƒŒæ™¯æ¸²æŸ“
        (function () {
            const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const stage = document.querySelector('.character-stage');
            const canvas = document.getElementById('character-canvas');
            const ctx = canvas ? canvas.getContext('2d') : null;
            const video = document.getElementById('character-video');
            const offscreen = document.createElement('canvas');
            const offCtx = offscreen.getContext('2d');
            let rafId = null;
            let natW = 0, natH = 0; // è§†é¢‘åŸå§‹å°ºå¯¸

            function resizeStage() {
                if (!stage || !canvas) return;
                const rect = stage.getBoundingClientRect();
                const stageW = Math.max(1, Math.floor(rect.width));
                // æ ¹æ®è§†é¢‘æ¯”ä¾‹è‡ªé€‚åº”é«˜åº¦ï¼ˆé™åˆ¶åœ¨ 200-380ï¼‰
                const ratio = (natW > 0 && natH > 0) ? (natH / natW) : (9 / 16);
                const targetH = Math.max(200, Math.min(380, Math.round(stageW * ratio)));
                // ç¡®ä¿ç”»å¸ƒå°ºå¯¸ä¸å½“å‰è§†é¢‘åŒ¹é…
                if (canvas.width !== stageW) canvas.width = stageW;
                if (canvas.height !== targetH) canvas.height = targetH;

                if (offscreen.width !== canvas.width) offscreen.width = canvas.width;
                if (offscreen.height !== canvas.height) offscreen.height = canvas.height;
            }

            window.addEventListener('resize', resizeStage);
            // åˆå§‹åŒ–ä¸€æ¬¡
            resizeStage();

            // åˆå§‹åŒ–è§†é¢‘æº
            if (video) {
                video.src = '/video/' + encodeURIComponent('æ€è€ƒ.mp4');
                video.addEventListener('loadedmetadata', () => {
                    natW = Math.max(1, video.videoWidth || natW);
                    natH = Math.max(1, video.videoHeight || natH);
                    resizeStage();
                });
            }

            function renderFrame() {
                if (!ctx || !offCtx || !video || video.paused || video.ended) { rafId = null; return; }
                try {
                    const cw = offscreen.width, ch = offscreen.height;
                    offCtx.clearRect(0, 0, cw, ch);
                    // ç­‰æ¯”ç¼©æ”¾å±…ä¸­ç»˜åˆ¶ï¼Œé¿å…è¢«æ‹‰ä¼¸
                    const vw = Math.max(1, video.videoWidth || natW || cw);
                    const vh = Math.max(1, video.videoHeight || natH || ch);
                    const scale = Math.min(cw / vw, ch / vh);
                    const dw = Math.floor(vw * scale);
                    const dh = Math.floor(vh * scale);
                    const dx = Math.floor((cw - dw) / 2);
                    const dy = Math.floor((ch - dh) / 2);
                    offCtx.drawImage(video, dx, dy, dw, dh);

                    // ç›´æ¥ç»˜åˆ¶åŸå§‹è§†é¢‘å†…å®¹ï¼Œä¸è¿›è¡ŒèƒŒæ™¯å¤„ç†
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(offscreen, 0, 0, canvas.width, canvas.height);
                } catch (err) {
                    // å¿½ç•¥å•å¸§é”™è¯¯ï¼Œç»§ç»­ä¸‹ä¸€å¸§
                }
                rafId = requestAnimationFrame(renderFrame);
            }

            // å¯¹å¤–æš´éœ²æ’­æ”¾å‡½æ•°
            window.playCharacterAnimation = function (loop = false) {
                console.log('playCharacterAnimationè¢«è°ƒç”¨ï¼Œloopå‚æ•°:', loop);
                if (!video || !canvas || prefersReduced) {
                    console.warn('æ’­æ”¾æ¡ä»¶ä¸æ»¡è¶³ - video:', !!video, 'canvas:', !!canvas, 'prefersReduced:', prefersReduced);
                    return;
                }

                // ç¡®ä¿è§†é¢‘æºå·²è®¾ç½®
                if (!video.src) {
                    console.warn('è§†é¢‘æºæœªè®¾ç½®');
                    return;
                }

                // è‹¥å·²è·çŸ¥å…ƒæ•°æ®ï¼Œå…ˆæŒ‰æ¯”ä¾‹æ›´æ–°èˆå°å°ºå¯¸
                if (video.videoWidth && video.videoHeight) {
                    natW = video.videoWidth;
                    natH = video.videoHeight;
                }
                resizeStage();
                // è®¾ç½®å¾ªç¯æ’­æ”¾
                video.loop = loop;
                console.log('è®¾ç½®è§†é¢‘å¾ªç¯æ’­æ”¾:', loop);
                // ä»å¤´æ’­æ”¾
                video.currentTime = 0;

                // ç«‹å³å¼€å§‹æ’­æ”¾ï¼Œä¸ç­‰å¾…åŠ è½½å®Œæˆ
                console.log('ç«‹å³å¼€å§‹æ’­æ”¾è§†é¢‘');
                try {
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('è§†é¢‘æ’­æ”¾æˆåŠŸ');
                            if (!rafId) rafId = requestAnimationFrame(renderFrame);
                        }).catch((err) => {
                            console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', err);

                            // å¤„ç† AbortError å’Œå…¶ä»–æ’­æ”¾é”™è¯¯
                            if (err.name === 'AbortError' || err.message.includes('interrupted')) {
                                console.log('è§’è‰²è§†é¢‘æ’­æ”¾è¢«ä¸­æ–­ï¼Œå°è¯•é‡æ–°æ’­æ”¾');
                                setTimeout(() => {
                                    if (video && !video.paused) return; // å¦‚æœå·²ç»åœ¨æ’­æ”¾åˆ™ä¸é‡è¯•
                                    video.play().catch(retryErr => {
                                        console.warn('è§’è‰²è§†é¢‘é‡è¯•æ’­æ”¾å¤±è´¥:', retryErr);
                                    });
                                }, 500);
                            }
                        });
                    }
                } catch (e) {
                    console.error('æ’­æ”¾å¼‚å¸¸:', e);
                }
            };

            // å¯¹å¤–æš´éœ²åœæ­¢æ’­æ”¾å‡½æ•°
            window.stopCharacterAnimation = function () {
                console.log('stopCharacterAnimationè¢«è°ƒç”¨');
                if (!video) {
                    console.warn('è§†é¢‘å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                try {
                    video.pause();
                    video.currentTime = 0;
                    console.log('è§†é¢‘å·²æš‚åœå¹¶é‡ç½®');
                    if (rafId) {
                        cancelAnimationFrame(rafId);
                        rafId = null;
                        console.log('åŠ¨ç”»å¸§å·²å–æ¶ˆ');
                    }
                    // æ¸…ç©ºç”»å¸ƒ
                    if (ctx && canvas) {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        console.log('ç”»å¸ƒå·²æ¸…ç©º');
                    }
                } catch (e) {
                    console.error('åœæ­¢åŠ¨ç”»å¼‚å¸¸:', e);
                }
            };

            // è­¦å‘ŠåŠ¨ç”»æ’­æ”¾å‡½æ•°
            window.playWarningAnimation = function () {
                console.log('playWarningAnimationè¢«è°ƒç”¨');
                const warningVideo = document.getElementById('warning-video');
                console.log('è­¦å‘Šè§†é¢‘å…ƒç´ :', warningVideo);
                const localPrefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                console.log('prefersReduced:', localPrefersReduced, 'canvas:', !!canvas);

                if (!warningVideo) {
                    console.error('è­¦å‘Šè§†é¢‘å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // è®¾ç½®è­¦å‘Šè§†é¢‘æº
                if (!warningVideo.src) {
                    warningVideo.src = '/video/' + encodeURIComponent('è­¦å‘Š.mp4');
                }

                if (!canvas) {
                    console.error('ç”»å¸ƒå…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                if (localPrefersReduced) {
                    console.warn('ç”¨æˆ·åå¥½å‡å°‘åŠ¨ç”»ï¼Œè·³è¿‡è­¦å‘ŠåŠ¨ç”»');
                    return;
                }

                // åœæ­¢å½“å‰æ’­æ”¾çš„è§’è‰²åŠ¨ç”»
                if (typeof stopCharacterAnimation === 'function') {
                    console.log('åœæ­¢è§’è‰²åŠ¨ç”»');
                    stopCharacterAnimation();
                }

                // ç¡®ä¿è­¦å‘Šè§†é¢‘æºå·²è®¾ç½®
                console.log('è­¦å‘Šè§†é¢‘src:', warningVideo.src);
                if (!warningVideo.src) {
                    console.error('è­¦å‘Šè§†é¢‘æºæœªè®¾ç½®');
                    return;
                }

                // è®¾ç½®ä¸å¾ªç¯æ’­æ”¾
                warningVideo.loop = false;
                console.log('è®¾ç½®è­¦å‘Šè§†é¢‘ä¸å¾ªç¯æ’­æ”¾');

                // ä»å¤´æ’­æ”¾
                warningVideo.currentTime = 0;
                console.log('é‡ç½®è§†é¢‘æ’­æ”¾æ—¶é—´åˆ°0');

                // ç«‹å³å¼€å§‹æ’­æ”¾è­¦å‘ŠåŠ¨ç”»
                console.log('å¼€å§‹æ’­æ”¾è­¦å‘Šè§†é¢‘');
                try {
                    const playPromise = warningVideo.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('è­¦å‘Šè§†é¢‘æ’­æ”¾æˆåŠŸ');
                            // ä½¿ç”¨è­¦å‘Šè§†é¢‘æ¸²æŸ“åˆ°ç”»å¸ƒ
                            renderWarningFrame(warningVideo);
                        }).catch((err) => {
                            console.error('è­¦å‘Šè§†é¢‘æ’­æ”¾å¤±è´¥:', err);

                            // å¤„ç† AbortError å’Œå…¶ä»–æ’­æ”¾é”™è¯¯
                            if (err.name === 'AbortError' || err.message.includes('interrupted')) {
                                console.log('è­¦å‘Šè§†é¢‘æ’­æ”¾è¢«ä¸­æ–­ï¼Œå°è¯•é‡æ–°æ’­æ”¾');
                                setTimeout(() => {
                                    if (warningVideo && !warningVideo.paused) return; // å¦‚æœå·²ç»åœ¨æ’­æ”¾åˆ™ä¸é‡è¯•
                                    warningVideo.play().catch(retryErr => {
                                        console.warn('è­¦å‘Šè§†é¢‘é‡è¯•æ’­æ”¾å¤±è´¥:', retryErr);
                                    });
                                }, 500);
                            }
                        });
                    } else {
                        console.log('è§†é¢‘æ’­æ”¾æ²¡æœ‰è¿”å›Promiseï¼Œç›´æ¥å¼€å§‹æ¸²æŸ“');
                        renderWarningFrame(warningVideo);
                    }
                } catch (e) {
                    console.error('è­¦å‘Šæ’­æ”¾å¼‚å¸¸:', e);
                }
            };

            // è­¦å‘ŠåŠ¨ç”»æ¸²æŸ“å‡½æ•°
            function renderWarningFrame(warningVideo) {
                if (!ctx || !offCtx || !warningVideo || warningVideo.paused || warningVideo.ended) {
                    console.log('è­¦å‘ŠåŠ¨ç”»æ¸²æŸ“ç»“æŸ');
                    return;
                }
                try {
                    const cw = offscreen.width, ch = offscreen.height;
                    offCtx.clearRect(0, 0, cw, ch);
                    // ç­‰æ¯”ç¼©æ”¾å±…ä¸­ç»˜åˆ¶ï¼Œé¿å…è¢«æ‹‰ä¼¸
                    const vw = Math.max(1, warningVideo.videoWidth || cw);
                    const vh = Math.max(1, warningVideo.videoHeight || ch);
                    const scale = Math.min(cw / vw, ch / vh);
                    const dw = Math.floor(vw * scale);
                    const dh = Math.floor(vh * scale);
                    const dx = Math.floor((cw - dw) / 2);
                    const dy = Math.floor((ch - dh) / 2);
                    offCtx.drawImage(warningVideo, dx, dy, dw, dh);

                    // ç›´æ¥ç»˜åˆ¶åŸå§‹è§†é¢‘å†…å®¹ï¼Œä¸è¿›è¡ŒèƒŒæ™¯å¤„ç†
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(offscreen, 0, 0, canvas.width, canvas.height);
                } catch (err) {
                    // å¿½ç•¥å•å¸§é”™è¯¯ï¼Œç»§ç»­ä¸‹ä¸€å¸§
                }
                requestAnimationFrame(() => renderWarningFrame(warningVideo));
            }
        })();
    </script>

    <script>
        (function () {
            const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                const onMove = (e) => {
                    const rect = btn.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    btn.style.setProperty('--mouse-x', x + 'px');
                    btn.style.setProperty('--mouse-y', y + 'px');
                    btn.style.setProperty('--glow-alpha', '1');
                };
                btn.addEventListener('mousemove', onMove);
                btn.addEventListener('mouseleave', () => {
                    btn.style.setProperty('--glow-alpha', '0');
                });
                btn.addEventListener('mousedown', (e) => {
                    if (prefersReduced) return;
                    const rect = btn.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    ripple.style.left = (x - 6) + 'px';
                    ripple.style.top = (y - 6) + 'px';
                    btn.appendChild(ripple);
                    ripple.addEventListener('animationend', () => ripple.remove());
                });
            });

            // èƒŒæ™¯æ¿ï¼ˆå®¹å™¨ï¼‰ç‚¹å‡»æ¶Ÿæ¼ª
            const container = document.querySelector('.container');
            if (container) {
                container.addEventListener('mousedown', (e) => {
                    if (prefersReduced) return;
                    // é¿å…ä¸æŒ‰é’®/è¾“å…¥/æ ‡ç­¾ç­‰äº¤äº’é‡å¤æ¶Ÿæ¼ª
                    if (e.target && e.target.closest('button, a, input, textarea, select, label, .tab')) return;
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple ripple-bg';
                    ripple.style.left = (x - 8) + 'px';
                    ripple.style.top = (y - 8) + 'px';
                    container.appendChild(ripple);
                    ripple.addEventListener('animationend', () => ripple.remove());
                });
            }
        })();
    </script>

    <!-- çµåŠ¨è§†é¢‘ç©ºé—²æ’­æ”¾ç³»ç»Ÿ -->
    <script>
        (function () {
            const actionVideos = [
                document.getElementById('action-video-1'),
                document.getElementById('action-video-2'),
                document.getElementById('action-video-3'),
                document.getElementById('action-video-4')
            ];

            // åˆå§‹åŒ–çµåŠ¨è§†é¢‘æº
            const actionVideoFiles = ['çµåŠ¨1.mp4', 'çµåŠ¨2.mp4', 'çµåŠ¨3.mp4', 'çµåŠ¨4.mp4'];
            actionVideos.forEach((video, index) => {
                if (video && actionVideoFiles[index]) {
                    video.src = '/video/' + encodeURIComponent(actionVideoFiles[index]);

                    // æ·»åŠ é”™è¯¯å¤„ç†
                    video.addEventListener('error', (e) => {
                        console.error(`çµåŠ¨è§†é¢‘åŠ è½½å¤±è´¥: ${video.src}`, e);
                    });

                    video.addEventListener('loadstart', () => {
                        console.log(`å¼€å§‹åŠ è½½çµåŠ¨è§†é¢‘: ${video.src}`);
                    });

                    video.addEventListener('canplay', () => {
                        console.log(`çµåŠ¨è§†é¢‘å¯ä»¥æ’­æ”¾: ${video.src}`);
                    });
                }
            });

            let idleTimer = null;
            let isIdle = false;
            let currentActionVideo = null;
            let actionRafId = null;
            let isPlayingAction = false;

            const IDLE_TIMEOUT = 5000; // 5ç§’æ— æ“ä½œåå¼€å§‹æ’­æ”¾çµåŠ¨è§†é¢‘

            // è·å–ç”»å¸ƒå’Œä¸Šä¸‹æ–‡
            const canvas = document.getElementById('character-canvas');
            const ctx = canvas ? canvas.getContext('2d') : null;
            const offscreen = document.createElement('canvas');
            const offCtx = offscreen.getContext('2d');

            // ä¸ºæ‰€æœ‰è§’è‰²åŠ¨ä½œè§†é¢‘æ·»åŠ å…ƒæ•°æ®åŠ è½½ç›‘å¬å™¨
            actionVideos.forEach(video => {
                if (video) {
                    video.addEventListener('loadedmetadata', () => {
                        console.log(`è§’è‰²åŠ¨ä½œè§†é¢‘å…ƒæ•°æ®å·²åŠ è½½: ${video.src}, å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}`);
                        // ç¡®ä¿ç”»å¸ƒå°ºå¯¸ä¸å½“å‰è§†é¢‘åŒ¹é…
                        updateActionCanvasSize();
                    });
                }
            });

            // æ›´æ–°è§’è‰²åŠ¨ä½œè§†é¢‘ç”»å¸ƒå°ºå¯¸
            function updateActionCanvasSize() {
                if (!canvas || !currentActionVideo) return;

                const stage = document.querySelector('.character-stage');
                if (!stage) return;

                const rect = stage.getBoundingClientRect();
                const stageW = Math.max(1, Math.floor(rect.width));

                // ä½¿ç”¨å½“å‰åŠ¨ä½œè§†é¢‘çš„çœŸå®æ¯”ä¾‹
                const videoW = Math.max(1, currentActionVideo.videoWidth || stageW);
                const videoH = Math.max(1, currentActionVideo.videoHeight || Math.round(stageW * 9 / 16));
                const ratio = videoH / videoW;
                const targetH = Math.max(200, Math.min(380, Math.round(stageW * ratio)));

                if (stage.style.height !== targetH + 'px') stage.style.height = targetH + 'px';

                // ä»…åœ¨å°ºå¯¸å˜åŒ–æ—¶æ›´æ–°ç”»å¸ƒï¼Œé¿å…æ¸…ç©ºå½“å‰å†…å®¹
                if (canvas.width !== stageW) canvas.width = stageW;
                if (canvas.height !== targetH) canvas.height = targetH;

                if (offscreen.width !== canvas.width) offscreen.width = canvas.width;
                if (offscreen.height !== canvas.height) offscreen.height = canvas.height;

                console.log(`è§’è‰²åŠ¨ä½œç”»å¸ƒå°ºå¯¸å·²æ›´æ–°: ${canvas.width}x${canvas.height}, è§†é¢‘æ¯”ä¾‹: ${ratio.toFixed(3)}`);
            }

            // ç”¨æˆ·æ´»åŠ¨äº‹ä»¶åˆ—è¡¨
            // const userEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
            const userEvents = []; // æ¸…ç©ºäº‹ä»¶åˆ—è¡¨ï¼Œè®©è§†é¢‘ä¿æŒå¸¸é©»æ’­æ”¾ï¼Œä¸å—ç”¨æˆ·æ“ä½œæ‰“æ–­

            // é‡ç½®ç©ºé—²è®¡æ—¶å™¨
            function resetIdleTimer() {
                if (idleTimer) {
                    clearTimeout(idleTimer);
                }

                // å¦‚æœå½“å‰æ­£åœ¨æ’­æ”¾çµåŠ¨è§†é¢‘ï¼Œåœæ­¢å®ƒ
                if (isIdle && isPlayingAction) {
                    stopActionVideo();
                }

                isIdle = false;

                idleTimer = setTimeout(() => {
                    isIdle = true;
                    // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è§†é¢‘åœ¨æ’­æ”¾
                    const characterVideo = document.getElementById('character-video');
                    const warningVideo = document.getElementById('warning-video');

                    if ((!characterVideo || characterVideo.paused) &&
                        (!warningVideo || warningVideo.paused)) {
                        startRandomActionVideo();
                    }
                }, IDLE_TIMEOUT);
            }

            // å¼€å§‹æ’­æ”¾éšæœºçµåŠ¨è§†é¢‘
            function startRandomActionVideo() {
                if (!isIdle || isPlayingAction) return;

                // éšæœºé€‰æ‹©ä¸€ä¸ªçµåŠ¨è§†é¢‘
                const randomIndex = Math.floor(Math.random() * actionVideos.length);
                currentActionVideo = actionVideos[randomIndex];

                if (!currentActionVideo || !canvas || !ctx) {
                    console.warn('çµåŠ¨è§†é¢‘æˆ–ç”»å¸ƒå…ƒç´ ä¸å¯ç”¨');
                    return;
                }

                // æ£€æŸ¥è§†é¢‘æ˜¯å¦å·²ç»åŠ è½½
                if (!currentActionVideo.src) {
                    console.error('çµåŠ¨è§†é¢‘æºæœªè®¾ç½®:', currentActionVideo);
                    return;
                }

                console.log('å¼€å§‹æ’­æ”¾çµåŠ¨è§†é¢‘:', currentActionVideo.src);
                isPlayingAction = true;

                // æ›´æ–°ç”»å¸ƒå°ºå¯¸ä»¥åŒ¹é…å½“å‰è§†é¢‘
                updateActionCanvasSize();

                // ç¡®ä¿å°ºå¯¸è°ƒæ•´æ²¡æœ‰æ¸…ç©ºç”»å¸ƒï¼ˆå¦‚æœå°ºå¯¸æ²¡å˜ï¼‰
                // å¦‚æœå°ºå¯¸å˜äº†ï¼Œç”»å¸ƒä¼šè¢«æ¸…ç©ºï¼Œè¿™æ˜¯ä¸å¯é¿å…çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥å°è¯•å°½å¿«ç»˜åˆ¶ç¬¬ä¸€å¸§

                // è®¾ç½®è§†é¢‘ä¸å¾ªç¯ï¼Œæ’­æ”¾å®Œåè‡ªåŠ¨é€‰æ‹©ä¸‹ä¸€ä¸ª
                currentActionVideo.loop = false;
                currentActionVideo.currentTime = 0;

                // ç›‘å¬è§†é¢‘ç»“æŸäº‹ä»¶
                currentActionVideo.addEventListener('ended', onActionVideoEnded);

                try {
                    const playPromise = currentActionVideo.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('çµåŠ¨è§†é¢‘æ’­æ”¾æˆåŠŸ');
                            if (!actionRafId) {
                                actionRafId = requestAnimationFrame(renderActionFrame);
                            }
                        }).catch((err) => {
                            console.error('çµåŠ¨è§†é¢‘æ’­æ”¾å¤±è´¥:', err);

                            // å¤„ç† AbortError å’Œå…¶ä»–æ’­æ”¾é”™è¯¯
                            if (err.name === 'AbortError' || err.message.includes('interrupted')) {
                                console.log('è§†é¢‘æ’­æ”¾è¢«ä¸­æ–­ï¼Œå°è¯•é‡æ–°æ’­æ”¾');
                                // å»¶è¿Ÿé‡è¯•æ’­æ”¾
                                setTimeout(() => {
                                    if (isIdle && currentActionVideo) {
                                        console.log('é‡æ–°å°è¯•æ’­æ”¾çµåŠ¨è§†é¢‘');
                                        currentActionVideo.play().catch(retryErr => {
                                            console.warn('é‡è¯•æ’­æ”¾å¤±è´¥:', retryErr);
                                            isPlayingAction = false;
                                            // å¦‚æœé‡è¯•å¤±è´¥ï¼Œå°è¯•æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘
                                            setTimeout(() => {
                                                if (isIdle) {
                                                    startRandomActionVideo();
                                                }
                                            }, 100);
                                        });
                                    }
                                }, 100);
                            } else {
                                isPlayingAction = false;
                                // å…¶ä»–é”™è¯¯ï¼Œå°è¯•æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘
                                setTimeout(() => {
                                    if (isIdle) {
                                        startRandomActionVideo();
                                    }
                                }, 100);
                            }
                        });
                    }
                } catch (e) {
                    console.error('çµåŠ¨è§†é¢‘æ’­æ”¾å¼‚å¸¸:', e);
                    isPlayingAction = false;
                }
            }

            // çµåŠ¨è§†é¢‘ç»“æŸå¤„ç†
            function onActionVideoEnded() {
                console.log('çµåŠ¨è§†é¢‘æ’­æ”¾ç»“æŸ');
                if (currentActionVideo) {
                    currentActionVideo.removeEventListener('ended', onActionVideoEnded);
                }

                if (actionRafId) {
                    cancelAnimationFrame(actionRafId);
                    actionRafId = null;
                }

                isPlayingAction = false;
                currentActionVideo = null;

                // å¦‚æœä»ç„¶ç©ºé—²ï¼Œç»§ç»­æ’­æ”¾ä¸‹ä¸€ä¸ªéšæœºè§†é¢‘
                if (isIdle) {
                    startRandomActionVideo();
                }
            }

            // åœæ­¢çµåŠ¨è§†é¢‘æ’­æ”¾
            function stopActionVideo() {
                if (currentActionVideo) {
                    console.log('åœæ­¢çµåŠ¨è§†é¢‘æ’­æ”¾');
                    currentActionVideo.pause();
                    currentActionVideo.currentTime = 0;
                    currentActionVideo.removeEventListener('ended', onActionVideoEnded);
                    currentActionVideo = null;
                }

                if (actionRafId) {
                    cancelAnimationFrame(actionRafId);
                    actionRafId = null;
                }

                isPlayingAction = false;

                // ç§»é™¤æ¸…ç©ºç”»å¸ƒçš„æ“ä½œï¼Œä¿ç•™æœ€åä¸€å¸§ï¼Œé¿å…é—ªçƒæˆ–ç™½å±
                // if (ctx && canvas) {
                //     ctx.clearRect(0, 0, canvas.width, canvas.height);
                // }
            }

            // æ¸²æŸ“çµåŠ¨è§†é¢‘å¸§
            function renderActionFrame() {
                if (!ctx || !offCtx || !currentActionVideo ||
                    currentActionVideo.paused || currentActionVideo.ended || !isPlayingAction) {
                    actionRafId = null;
                    return;
                }

                try {
                    const cw = offscreen.width, ch = offscreen.height;
                    offCtx.clearRect(0, 0, cw, ch);

                    // ç¡®ä¿è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½
                    if (currentActionVideo.readyState < 2) {
                        actionRafId = requestAnimationFrame(renderActionFrame);
                        return;
                    }

                    // ç­‰æ¯”ç¼©æ”¾å±…ä¸­ç»˜åˆ¶ï¼Œä¸renderFrameä¿æŒä¸€è‡´
                    const vw = Math.max(1, currentActionVideo.videoWidth || cw);
                    const vh = Math.max(1, currentActionVideo.videoHeight || ch);
                    const scale = Math.min(cw / vw, ch / vh);
                    const dw = Math.floor(vw * scale);
                    const dh = Math.floor(vh * scale);
                    const dx = Math.floor((cw - dw) / 2);
                    const dy = Math.floor((ch - dh) / 2);

                    // ä½¿ç”¨é«˜è´¨é‡æ¸²æŸ“
                    offCtx.imageSmoothingEnabled = true;
                    offCtx.imageSmoothingQuality = 'high';
                    offCtx.drawImage(currentActionVideo, dx, dy, dw, dh);

                    // ç»˜åˆ¶åˆ°ä¸»ç”»å¸ƒï¼Œä¿æŒé«˜è´¨é‡
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(offscreen, 0, 0, canvas.width, canvas.height);
                } catch (err) {
                    console.warn('è§’è‰²åŠ¨ä½œè§†é¢‘æ¸²æŸ“é”™è¯¯:', err);
                }

                actionRafId = requestAnimationFrame(renderActionFrame);
            }

            // ç›‘å¬ç”¨æˆ·æ´»åŠ¨äº‹ä»¶
            userEvents.forEach(eventType => {
                document.addEventListener(eventType, resetIdleTimer, true);
            });

            // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹è®¡æ—¶
            window.addEventListener('load', () => {
                resetIdleTimer();
            });

            // ä¿®æ”¹ç°æœ‰çš„æ’­æ”¾å‡½æ•°ï¼Œç¡®ä¿åœæ­¢çµåŠ¨è§†é¢‘
            const originalPlayCharacterAnimation = window.playCharacterAnimation;
            const originalPlayWarningAnimation = window.playWarningAnimation;

            window.playCharacterAnimation = function (loop = false) {
                // åœæ­¢çµåŠ¨è§†é¢‘
                if (isPlayingAction) {
                    stopActionVideo();
                }
                // é‡ç½®ç©ºé—²çŠ¶æ€
                resetIdleTimer();
                // è°ƒç”¨åŸå§‹å‡½æ•°
                if (originalPlayCharacterAnimation) {
                    return originalPlayCharacterAnimation.call(this, loop);
                }
            };

            window.playWarningAnimation = function () {
                // åœæ­¢çµåŠ¨è§†é¢‘
                if (isPlayingAction) {
                    stopActionVideo();
                }
                // é‡ç½®ç©ºé—²çŠ¶æ€
                resetIdleTimer();
                // è°ƒç”¨åŸå§‹å‡½æ•°
                if (originalPlayWarningAnimation) {
                    return originalPlayWarningAnimation.call(this);
                }
            };

            // å¯¹å¤–æš´éœ²åœæ­¢çµåŠ¨è§†é¢‘çš„å‡½æ•°
            window.stopActionVideo = stopActionVideo;
        })();
    </script>
</body>

</html>